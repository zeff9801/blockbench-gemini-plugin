name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - release

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages-${{ github.event_name }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      deploy_path: ${{ steps.set-path.outputs.deploy_path }}
      should_deploy: ${{ steps.check-deploy.outputs.should_deploy }}
      is_latest_release: ${{ steps.set-path.outputs.is_latest_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if should deploy PR
        id: check-deploy
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;

            if (eventName === 'pull_request') {
              const prAuthor = context.payload.pull_request.user.login;
              const { data: permissionData } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: prAuthor
              });

              const permission = permissionData.permission;
              const hasWriteAccess = ['admin', 'write'].includes(permission);

              console.log(`PR author: ${prAuthor}, Permission: ${permission}, Has write access: ${hasWriteAccess}`);
              core.setOutput('should_deploy', hasWriteAccess.toString());
            } else {
              core.setOutput('should_deploy', 'true');
            }

      - name: Determine deployment path
        id: set-path
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            echo "deploy_path=${TAG}" >> $GITHUB_OUTPUT
            echo "is_latest_release=true" >> $GITHUB_OUTPUT
            echo "Deploying release: ${TAG}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            echo "deploy_path=pr/${PR_NUM}" >> $GITHUB_OUTPUT
            echo "is_latest_release=false" >> $GITHUB_OUTPUT
            echo "Deploying PR preview: pr/${PR_NUM}"
          else
            echo "deploy_path=nightly" >> $GITHUB_OUTPUT
            echo "is_latest_release=false" >> $GITHUB_OUTPUT
            echo "Deploying nightly build"
          fi

      - name: Setup Bun
        if: steps.check-deploy.outputs.should_deploy == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check-deploy.outputs.should_deploy == 'true'
        run: bun install

      - name: Build plugin
        if: steps.check-deploy.outputs.should_deploy == 'true'
        run: bun run build

      - name: Upload build artifact
        if: steps.check-deploy.outputs.should_deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: plugin-build
          path: |
            ./dist/mcp.js
            ./dist/about.md
          retention-days: 7

  deploy:
    needs: build
    if: needs.build.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: https://jasonjgardner.github.io/blockbench-mcp-plugin/${{ needs.build.outputs.deploy_path }}/mcp.js
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Initialize gh-pages if not exists
        run: |
          if [ ! -f "index.html" ]; then
            echo "Initializing gh-pages branch"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            echo "<!DOCTYPE html><html><head><title>Blockbench MCP Plugin</title></head><body><h1>Blockbench MCP Plugin Downloads</h1></body></html>" > index.html
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-build
          path: ./artifact

      - name: Deploy to versioned path
        run: |
          DEPLOY_PATH="${{ needs.build.outputs.deploy_path }}"

          # Create directory and copy only mcp.js and about.md
          mkdir -p "${DEPLOY_PATH}"
          cp ./artifact/mcp.js "${DEPLOY_PATH}/"
          cp ./artifact/about.md "${DEPLOY_PATH}/"

          echo "Deployed to ${DEPLOY_PATH}/"
          ls -la "${DEPLOY_PATH}/"

      - name: Deploy to root (latest release only)
        if: needs.build.outputs.is_latest_release == 'true'
        run: |
          # Copy only mcp.js and about.md to root for latest release
          cp ./artifact/mcp.js ./
          cp ./artifact/about.md ./
          echo "Deployed to root (latest release)"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          DEPLOY_PATH="${{ needs.build.outputs.deploy_path }}"

          if [[ "${{ needs.build.outputs.is_latest_release }}" == "true" ]]; then
            git commit -m "Deploy release ${DEPLOY_PATH}" || echo "No changes to commit"
          elif [[ "${DEPLOY_PATH}" == pr/* ]]; then
            git commit -m "Deploy PR preview ${DEPLOY_PATH}" || echo "No changes to commit"
          else
            git commit -m "Deploy nightly build" || echo "No changes to commit"
          fi

          git push origin gh-pages

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deployPath = '${{ needs.build.outputs.deploy_path }}';
            const baseUrl = 'https://jasonjgardner.github.io/blockbench-mcp-plugin';

            const body = `## Preview Deployment

            Your changes have been deployed for preview:

            **Plugin URL:** \`${baseUrl}/${deployPath}/mcp.js\`

            You can load this plugin in Blockbench via File > Plugins > Load Plugin from URL.

            _This preview will be automatically cleaned up when the PR is closed._`;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
